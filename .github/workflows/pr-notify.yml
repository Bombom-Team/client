name: PR Notifications

on:
  pull_request:
    types: [opened, reopened, ready_for_review]

jobs:
  notify-reviewers:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - uses: actions/checkout@v3

      # reviewers.json ê¸°ë°˜ìœ¼ë¡œ reviewer = 3ëª…, author ì œì™¸ í›„ ë©˜ì…˜
      - name: Load Reviewers from JSON
        id: get-reviewers
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const mapping = JSON.parse(fs.readFileSync('.github/notify_ids.json', 'utf8'));

            // JSON key ëª©ë¡ = GitHub login ëª©ë¡ (3ëª…)
            const team = Object.keys(mapping);

            // PR ì‘ì„±ì
            const author = context.payload.pull_request.user.login;

            // author ì œì™¸
            const filtered = team.filter(member => member !== author);

            // ë””ìŠ¤ì½”ë“œ ë©˜ì…˜ ë¬¸ìì—´ë¡œ ë³€í™˜
            const mentions = filtered
              .map(login => `<@${mapping[login]}>`)
              .join(' ');

            console.log("Final Discord Mentions:", mentions);
            core.setOutput("discord_mentions", mentions);

      # Discord ì•Œë¦¼ ì „ì†¡
      - name: Send notification to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_PR }}
          TITLE: ${{ github.event.pull_request.title }}
          AUTHOR: ${{ github.event.pull_request.user.login }}
          URL: ${{ github.event.pull_request.html_url }}
          MENTIONS: ${{ steps.get-reviewers.outputs.discord_mentions }}
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"username\": \"FE Bot\",
              \"content\": \"ğŸš€ ìƒˆ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ë¦¬ë·° ë¶€íƒë“œë¦½ë‹ˆë‹¤ ğŸ™\n${MENTIONS}\",
              \"embeds\": [
                {
                  \"title\": \"${TITLE}\",
                  \"url\": \"${URL}\",
                  \"color\": 16753920,
                  \"fields\": [
                    {
                      \"name\": \"ì‘ì„±ì\",
                      \"value\": \"${AUTHOR}\",
                      \"inline\": true
                    }
                  ],
                  \"footer\": {
                    \"text\": \"ì‘ì€ ë¦¬ë·° í•˜ë‚˜ê°€ í° ê°œì„ ì´ ë©ë‹ˆë‹¤ ğŸ™Œ\"
                  }
                }
              ]
            }" \
            "$DISCORD_WEBHOOK_URL"
