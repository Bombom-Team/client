name: PR Review Request Notifications

on:
  pull_request:
    types: [review_requested]

jobs:
  notify-review-request:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # notify_ids.jsonc ê¸°ë°˜ìœ¼ë¡œ ë¦¬ë·°ì–´ë¥¼ mention ë³€í™˜
      - name: Load user mapping
        id: load-users
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require("fs");
            const mapping = JSON.parse(fs.readFileSync('.github/notify_ids.jsonc', 'utf8'));

            const reviewer = context.payload.requested_reviewer.login;
            const reviewerMention = mapping[reviewer] ? `<@${mapping[reviewer]}>` : reviewer;

            console.log(`Reviewer Mention: ${reviewerMention}`);
            core.setOutput("reviewer", reviewerMention);

      # Discord ì•Œë¦¼ ì „ì†¡
      - name: Send Re-request Review Notification
        uses: ./.github/actions/discord-notify
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_PR }}
          content: "ğŸ”„ *ë¦¬ë·°ê°€ ë‹¤ì‹œ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤!*"
          mentions: ${{ steps.load-users.outputs.reviewer }}
          title: ${{ github.event.pull_request.title }}
          url: ${{ github.event.pull_request.html_url }}
          color: 3447003
          fields: |
            [
              { "name": "ì‘ì„±ì", "value": "${{ github.event.pull_request.user.login }}" },
              { "name": "ìš”ì²­ëœ ë¦¬ë·°ì–´", "value": "${{ steps.load-users.outputs.reviewer }}" }
            ]
