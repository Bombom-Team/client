name: PR Review Request Notifications

on:
  pull_request:
    types: [review_requested]

jobs:
  notify-review-request:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Load user mapping
        id: load-users
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require("fs");
            const mapping = JSON.parse(fs.readFileSync('.github/notify_ids.json', 'utf8'));

            const pr = context.payload.pull_request;
            const reviewer = context.payload.requested_reviewer.login;
            const author   = pr.user.login;

            const reviewerMention = mapping[reviewer] ? `<@${mapping[reviewer]}>` : reviewer;
            const author   = mapping[author] ? `<@${mapping[author]}>` : author;

            core.setOutput("reviewer", reviewerMention);
            core.setOutput("author", author);

      - name: Send notification to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_PR }}
          TITLE: ${{ github.event.pull_request.title }}
          URL: ${{ github.event.pull_request.html_url }}
          AUTHOR: ${{ github.event.pull_request.user.login }}
          REVIEWER: ${{ steps.load-users.outputs.reviewer }}
        run: |
          MESSAGE="ğŸ”„ *ë¦¬ë·°ê°€ ë‹¤ì‹œ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤!*"

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"username\": \"FE Bot\",
              \"content\": \"$MESSAGE\në¦¬ë·°ì–´: $REVIEWER\",
              \"embeds\": [
                {
                  \"title\": \"$TITLE\",
                  \"url\": \"$URL\",
                  \"color\": 3447003,
                  \"fields\": [
                    {
                      \"name\": \"ì‘ì„±ì\",
                      \"value\": \"$AUTHOR\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"ìš”ì²­ëœ ë¦¬ë·°ì–´\",
                      \"value\": \"$REVIEWER\",
                      \"inline\": true
                    }
                  ],
                  \"footer\": {
                    \"text\": \"ë¦¬ë·° ë¶€íƒë“œë¦½ë‹ˆë‹¤ ğŸ™\"
                  }
                }
              ]
            }" \
            "$DISCORD_WEBHOOK_URL"
