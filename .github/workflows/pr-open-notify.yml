name: PR Open Notifications

on:
  pull_request:
    types: [opened, reopened, ready_for_review]

jobs:
  notify-reviewers:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - uses: actions/checkout@v3

      # reviewers.json ê¸°ë°˜ìœ¼ë¡œ reviewer = 3ëª…, author ì œì™¸ í›„ ë©˜ì…˜
      - name: Load Reviewers from JSON
        id: get-reviewers
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const mapping = JSON.parse(fs.readFileSync('.github/notify_ids.json', 'utf8'));

            // JSON key ëª©ë¡ = GitHub login ëª©ë¡ (3ëª…)
            const members = Object.keys(mapping);

            // PR ì‘ì„±ì
            const author = context.payload.pull_request.user.login;

            // author ì œì™¸
            const filtered = members.filter(member => member !== author);

            // ë””ìŠ¤ì½”ë“œ ë©˜ì…˜ ë¬¸ìì—´ë¡œ ë³€í™˜
            const mentions = filtered
              .map(login => `<@${mapping[login]}>`)
              .join(' ');

            core.setOutput("discord_mentions", mentions);

      # Discord ì•Œë¦¼ ì „ì†¡
      - name: Send PR Open Notification
        uses: ./.github/actions/discord-notify
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_PR }}
          content: "ğŸš€ ìƒˆ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ë¦¬ë·° ë¶€íƒë“œë¦½ë‹ˆë‹¤ ğŸ™\n${{ steps.get-reviewers.outputs.discord_mentions }}"
          mentions: ${{ steps.get-reviewers.outputs.discord_mentions }}
          title: ${{ github.event.pull_request.title }}
          url: ${{ github.event.pull_request.html_url }}
          color: 16753920
          fields: |
            [
              { "name": "ì‘ì„±ì", "value": "${{ github.event.pull_request.user.login }}" }
            ]
