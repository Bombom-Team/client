name: PR Open Notifications

on:
  pull_request:
    types: [opened, reopened, ready_for_review]

jobs:
  notify-reviewers:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    permissions:
      pull-requests: write
      contents: read

    steps:
      - uses: actions/checkout@v3

      # PR ì‘ì„±ìë¥¼ Assigneeë¡œ ìë™ ì„¤ì •
      - name: Auto Assign PR Author
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            const author = pr.user.login;

            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              assignees: [author]
            });

            console.log(`Assigned ${author} as PR assignee`);

      # frontend íŒ€ reviewers ìë™ ë°°ì •
      - name: Auto Assign Reviewers
        uses: kentaro-m/auto-assign-action@v1.2.1
        with:
          configuration-path: .github/auto_assign_frontend.yml

      # notify_ids.json frontend ê·¸ë£¹ ìƒìœ„ 3ëª… ê¸°ë°˜ ë©˜ì…˜ êµ¬ì„±
      - name: Load Reviewers from JSON
        id: get-reviewers
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const mapping = JSON.parse(fs.readFileSync('.github/notify_ids.json', 'utf8'));
            const members = Object.keys(mapping);
            const frontends = members.slice(0, 3);

            const author = context.payload.pull_request.user.login;
            const filtered = frontends.filter(member => member !== author);

            const mentions = filtered
              .map(login => `<@${mapping[login]}>`)
              .join(' ');

            console.log(`Mentions: ${mentions}`);
            core.setOutput("discord_mentions", mentions);

      # Discord ì•Œë¦¼ ì „ì†¡
      - name: Send PR Open Notification
        uses: ./.github/actions/discord-notify
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_PR }}
          content: "ğŸš€ ìƒˆ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ë¦¬ë·° ë¶€íƒë“œë¦½ë‹ˆë‹¤ ğŸ™"
          mentions: ${{ steps.get-reviewers.outputs.discord_mentions }}
          title: ${{ github.event.pull_request.title }}
          url: ${{ github.event.pull_request.html_url }}
          color: 16753920
          fields: |
            [
              { "name": "ì‘ì„±ì", "value": "${{ github.event.pull_request.user.login }}" }
            ]
