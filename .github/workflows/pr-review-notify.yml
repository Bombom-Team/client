name: PR Review Notifications

on:
  pull_request_review:
    types: [submitted]

jobs:
  notify-on-review:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # reviewers.json ê¸°ë°˜ìœ¼ë¡œ ë¦¬ë·°ì–´/ì‘ì„±ìë¥¼ mention ë³€í™˜
      - name: Load user mapping
        id: load-users
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require("fs");
            const mapping = JSON.parse(fs.readFileSync(".github/notify_ids.json", "utf8"));

            const review = context.payload.review;
            const pr = context.payload.pull_request;

            const reviewer = review.user.login;
            const author = pr.user.login;

            const reviewer = mapping[reviewer] ? `${mapping[reviewer]}` : reviewer;
            const authorMention   = mapping[author] ? `<@${mapping[author]}>` : author;

            return {
              reviewer,
              authorMention
            };
          result-encoding: json

      # ìŠ¹ì¸/ë³€ê²½ìš”ì²­ ìƒíƒœ íŒë³„
      - name: Determine review state
        id: state
        run: |
          echo "state=${{ github.event.review.state }}" >> $GITHUB_OUTPUT

      # Discord ì•Œë¦¼ ì „ì†¡
      - name: Send notification to Discord
        if: ${{ steps.state.outputs.state == 'approved' || steps.state.outputs.state == 'changes_requested' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_PR }}
          STATE: ${{ steps.state.outputs.state }}
          TITLE: ${{ github.event.pull_request.title }}
          URL: ${{ github.event.pull_request.html_url }}
          REVIEWER: ${{ steps.load-users.outputs.reviewer }}
          AUTHOR: ${{ steps.load-users.outputs.authorMention }}
        run: |
          if [ "$STATE" = "approved" ]; then
            MESSAGE="ğŸ‰ *PRì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!*"
            COLOR=3066993
          else
            MESSAGE="âš ï¸ *ìˆ˜ì • ìš”ì²­ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤!*"
            COLOR=15158332
          fi

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"username\": \"FE Bot\",
              \"content\": \"$MESSAGE\në¦¬ë·°ì–´: $REVIEWER\",
              \"embeds\": [
                {
                  \"title\": \"${TITLE}\",
                  \"url\": \"${URL}\",
                  \"color\": $COLOR,
                  \"fields\": [
                    {
                      \"name\": \"ì‘ì„±ì\",
                      \"value\": \"${AUTHOR}\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"ë¦¬ë·°ì–´\",
                      \"value\": \"${REVIEWER}\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"ë¦¬ë·° ìƒíƒœ\",
                      \"value\": \"${STATE}\",
                      \"inline\": true
                    }
                  ],
                  \"footer\": {
                    \"text\": \"ë¦¬ë·° ë°˜ì˜ í›„ ë‹¤ì‹œ ì•Œë ¤ì£¼ì„¸ìš” ğŸ™‡â€â™‚ï¸\"
                  }
                }
              ]
            }" \
            "$DISCORD_WEBHOOK_URL"
