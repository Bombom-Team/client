name: PR Approved Notifications

on:
  pull_request_review:
    types: [submitted]

jobs:
  notify-on-review:
    runs-on: ubuntu-latest
    if: ${{ github.event.review.state == 'approved' }}

    steps:
      - uses: actions/checkout@v3

      # notify_ids.json ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±ìë¥¼ mention ë³€í™˜
      - name: Load user mapping
        id: load-users
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require("fs");
            const mapping = JSON.parse(fs.readFileSync('.github/notify_ids.json', 'utf8'));

            const pr = context.payload.pull_request;

            const author = pr.user.login;
            const authorMention   = mapping[author] ? `<@${mapping[author]}>` : author;

            core.setOutput("authorMention", authorMention);

      # ğŸ” í˜„ì¬ê¹Œì§€ APPROVED ë¦¬ë·° ìˆ˜ ê³„ì‚°
      - name: Count approvals
        id: approval-count
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            // ë¦¬ë·° ì „ì²´ ì¡°íšŒ
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // APPROVED ìƒíƒœë§Œ í•„í„°ë§
            const approvals = reviews.filter(r => r.state === "APPROVED");

            core.setOutput("count", approvals.length);
            core.setOutput("approvedReviewers", approvals.map(a => a.user.login).join(', '));

      # Discord ì•Œë¦¼ ì „ì†¡ (ì¡°ê±´: approve 2ëª… ì´ìƒ)
      - name: Send notification to Discord
        if: ${{ github.event.review.state == 'approved' && steps.approval-count.outputs.count >= 2 }}
        uses: ./.github/actions/discord-notify
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_PR }}
          content: "ğŸ‰ *PRì´ ìµœì¢… ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!*"
          mentions: ${{ steps.load-users.outputs.authorMention }}
          title: ${{ github.event.pull_request.title }}
          url: ${{ github.event.pull_request.html_url }}
          color: 3066993
          fields: |
            [
              { "name": "ìŠ¹ì¸ì ëª©ë¡", "value": "${{ steps.approval-count.outputs.approvedReviewers }}" },
              { "name": "ìŠ¹ì¸ ìˆ˜", "value": "${{ steps.approval-count.outputs.count }}" }
            ]
