name: PR Request Changes Notifications

on:
  pull_request_review:
    types: [submitted]

jobs:
  notify-on-request-changes:
    runs-on: ubuntu-latest
    if: ${{ github.event.review.state == 'changes_requested' }}

    steps:
      - uses: actions/checkout@v3

      # notify_ids.json 기반으로 리뷰어/작성자 mention 변환
      - name: Load user mapping
        id: load-users
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require("fs");
            const mapping = JSON.parse(fs.readFileSync('.github/notify_ids.json', 'utf8'));

            const review = context.payload.review;
            const pr = context.payload.pull_request;

            const reviewer = review.user.login;
            const author = pr.user.login;
            const authorMention   = mapping[author] ? `<@${mapping[author]}>` : author;

            core.setOutput("reviewer", reviewer);
            core.setOutput("authorMention", authorMention);

      # Discord 알림 전송
      - name: Send Request Changes Notification
        uses: ./.github/actions/discord-notify
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_PR }}
          title: ${{ github.event.pull_request.title }}
          url: ${{ github.event.pull_request.html_url }}
          content: "⚠️ *수정 요청이 들어왔습니다!*"
          mentions: ${{ steps.load-users.outputs.authorMention }}
          color: 15158332
          fields: |
            [
              { "name": "리뷰어", "value": "${{ steps.load-users.outputs.reviewer }}" },
              { "name": "상태", "value": "${{ github.event.review.state }}" }
            ]
